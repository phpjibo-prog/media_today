<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamFetch | Pro Downloader</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<style>
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
        margin-right: 8px;
    }
</style>
    
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-6">

    <div class="max-w-2xl w-full bg-gray-800 rounded-2xl shadow-2xl p-8 border border-gray-700">
        <h1
            class="text-3xl font-bold mb-6 text-center bg-gradient-to-r from-red-500 to-orange-400 bg-clip-text text-transparent">
            Jibo YouTube Downloader
        </h1>

        <div class="flex flex-col sm:flex-row gap-3 mb-8">
            <input
                type="text"
                id="urlInput"
                placeholder="Paste YouTube link here..."
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3
                       focus:outline-none focus:ring-2 focus:ring-red-500 transition"
            >
        
            <button
                onclick="fetchVideoInfo()"
                class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg
                       font-semibold transition w-full sm:w-auto"
            >
                Download
            </button>
        </div>

        <div class="mb-10 p-6 bg-gray-750 border border-dashed border-gray-600 rounded-2xl">
            <h2 class="text-lg font-semibold mb-4 text-gray-300">Search YouTube</h2>
            <div class="flex gap-3">
                <input type="text" id="searchInput" placeholder="Search for videos..." 
                       class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                <button onclick="searchVideos()" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-semibold transition">
                    Search
                </button>
            </div>
            
            <div id="searchResults" class="mt-6 space-y-3"></div>
        </div>
        
        <hr class="border-gray-700 mb-10">

        <div id="videoDetails" class="hidden mb-8 p-4 bg-gray-750 border border-gray-700 rounded-xl">
            <div class="flex gap-4">
                <img id="thumb" class="w-32 rounded-lg object-cover" src="" alt="Thumbnail">
                <div>
                    <h3 id="videoTitle" class="font-bold text-lg line-clamp-2"></h3>
                    <p id="videoDuration" class="text-gray-400 text-sm"></p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mt-6">
                <div>
                    <h4 class="text-xs font-bold uppercase text-gray-500 mb-2">Audio (MP3)</h4>
                    <button onclick="download('mp3', '320')"
                        class="w-full mb-2 bg-gray-700 hover:bg-gray-600 text-sm py-2 rounded">320kbps</button>
                    <button onclick="download('mp3', '128')"
                        class="w-full bg-gray-700 hover:bg-gray-600 text-sm py-2 rounded">128kbps</button>
                </div>
                <div>
                    <h4 class="text-xs font-bold uppercase text-gray-500 mb-2">Video (MP4)</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="download('mp4', '1080')"
                            class="bg-blue-600 hover:bg-blue-700 text-xs py-2 rounded">1080p</button>
                        <button onclick="download('mp4', '720')"
                            class="bg-gray-700 hover:bg-gray-600 text-xs py-2 rounded">720p</button>
                        <button onclick="download('mp4', '480')"
                            class="bg-gray-700 hover:bg-gray-600 text-xs py-2 rounded">480p</button>
                        <button onclick="download('mp4', '360')"
                            class="bg-gray-700 hover:bg-gray-600 text-xs py-2 rounded">360p</button>
                    </div>
                </div>
            </div>
        </div>

        <p id="status" class="text-center text-sm text-gray-400 mt-4"></p>

        <div id="progressContainer" class="hidden w-full bg-gray-700 rounded-full h-4 mb-4 overflow-hidden">
            <div id="progressBar" class="bg-red-600 h-full transition-all duration-300" style="width: 0%"></div>
        </div>
        <p id="progressText" class="text-center text-xs text-gray-400 mb-2"></p>
        
    </div>

    <script>
        async function fetchVideoInfo() {
            const url = document.getElementById('urlInput').value;
            const status = document.getElementById('status');
            status.innerText = "Analyzing video...";

            const response = await fetch('/get_info', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url })
            });
            const data = await response.json();

            if (data.error) {
                status.innerText = "Error: " + data.error;
            } else {
                document.getElementById('videoDetails').classList.remove('hidden');
                document.getElementById('videoTitle').innerText = data.title;
                document.getElementById('videoDuration').innerText = "Duration: " + data.duration;
                document.getElementById('thumb').src = data.thumbnail;
                status.innerText = "";
            }
        }

        async function download(format, quality) {
            const url = document.getElementById('urlInput').value;
            const status = document.getElementById('status');
            status.innerText = `üîÑ Preparing your ${quality} ${format}... Please wait.`;
        
            try {
                const response = await fetch('/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, format, quality })
                });
        
                // Check if the server returned an error (e.g., timeout or conversion error)
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Download failed');
                }
        
                // 1. Get the real filename from the server's Content-Disposition header
                // This ensures the file saves with the actual YouTube video title
                const disposition = response.headers.get('Content-Disposition');
                let filename = format === 'mp3' ? `audio_${quality}k.mp3` : `video_${quality}p.mp4`;
                
                if (disposition && disposition.indexOf('attachment') !== -1) {
                    const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                    const matches = filenameRegex.exec(disposition);
                    if (matches != null && matches[1]) { 
                        filename = matches[1].replace(/['"]/g, '');
                    }
                }
        
                // 2. Process the incoming data stream as a Blob
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
        
                // 3. Trigger the browser's download dialog
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = filename; 
                document.body.appendChild(a);
                a.click();
        
                // 4. Cleanup to free up browser memory
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);
                status.innerText = "‚úÖ Download complete!";
        
            } catch (err) {
                console.error(err);
                status.innerText = "‚ùå " + err.message;
            }
        } 

        async function download(format, quality) {
            const url = document.getElementById('urlInput').value;
            const status = document.getElementById('status');
            const pContainer = document.getElementById('progressContainer');
            const pBar = document.getElementById('progressBar');
            const pText = document.getElementById('progressText');
        
            status.innerText = `üîÑ Processing ${quality} ${format}...`;
            pContainer.classList.remove('hidden');
            pBar.style.width = '0%';
        
            try {
                const response = await fetch('/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, format, quality })
                });
        
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Download failed');
                }
        
                const contentLength = response.headers.get('Content-Length');
                const total = parseInt(contentLength, 10);
                let loaded = 0;
        
                const reader = response.body.getReader();
                const chunks = [];
        
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
        
                    chunks.push(value);
                    loaded += value.length;
        
                    if (total) {
                        const percent = Math.round((loaded / total) * 100);
                        pBar.style.width = `${percent}%`;
                        pText.innerText = `${percent}% downloaded (${(loaded / 1024 / 1024).toFixed(1)} MB)`;
                    }
                }
        
                // Combine chunks into a single Blob
                const blob = new Blob(chunks);
                const downloadUrl = window.URL.createObjectURL(blob);
                
                // Handle Filename
                const disposition = response.headers.get('Content-Disposition');
                let filename = format === 'mp3' ? `audio.mp3` : `video.mp4`;
                if (disposition && disposition.includes('filename=')) {
                    filename = disposition.split('filename=')[1].replace(/['"]/g, '');
                }
        
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                
                window.URL.revokeObjectURL(downloadUrl);
                status.innerText = "‚úÖ Download complete!";
                pContainer.classList.add('hidden');
                pText.innerText = "";
        
            } catch (err) {
                status.innerText = "‚ùå " + err.message;
                pContainer.classList.add('hidden');
            }
        }
        
    </script>
</body>

</html>
